---
import { getCollection, type CollectionEntry } from "astro:content";
import { fetchMeta } from "../../utils/fetchMeta";
import Redirecionamento from "../../components/Redirecionamento.astro"

export type Props = {
  slug: string;
  target: string;
  permanent: boolean;
  bridgeLinks: string[];
  meta: {
    title?: string;
    description?: string;
    image?: string;
  };
}

export async function getStaticPaths() {
  const permalinks = await getCollection("permalinks");
  const permalinkMap = new Map(permalinks.map(p => [p.data.slug, p]));

  return await Promise.all(permalinks.map(async ({ id, data }) => {
    let finalTarget = data.target;
    let permanent = data.permanent;
    const bridgeLinks: string[] = [];
    
    // Crawl through bridge links
    while (finalTarget.startsWith("/p/")) {
      const slug = finalTarget.substring(3); // Remove "/p/"
      const nextLink = permalinkMap.get(slug);
      
      if (!nextLink) {
        // Dead link, stop crawling
        break;
      }
      
      bridgeLinks.push(finalTarget);
      
      // If any intermediate link is not permanent, final result is not permanent
      if (!nextLink.data.permanent) {
        permanent = false;
      }
      
      finalTarget = nextLink.data.target;
    }

    const meta = import.meta.env.PROD ? await fetchMeta(finalTarget) : {}

    // Add UTM parameter if it's an external URL
    try {
      const targetUrl = new URL(finalTarget);
      targetUrl.searchParams.set("utm_source", "conteudo.redeisf.pro.br");
      finalTarget = targetUrl.toString();
    } catch (err) {
      // Not a valid URL or relative path, keep as is
    }

    return {
      params: { slug: data.slug },
      props: { slug: data.slug, target: finalTarget, permanent, bridgeLinks, meta },
    }
  }));
}

const { slug, target, permanent, bridgeLinks, meta } = Astro.props;
const redirectType = permanent ? "permanente" : "temporário";
---
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content={`0;url=${target}`} />
  {permanent && <link rel="canonical" href={target} />}
  <meta name="robots" content={permanent ? 'index, follow' : 'noindex, follow'} />

  <title>{meta.title ?? "Redirecionando..."}</title>
  <meta property="og:title" content={meta.title ?? "Redirecionando..."} />

  {meta.description && <meta name="description" content={meta.description} />}
  {meta.description && <meta property="og:description" content={meta.description} />}
  {meta.image && <meta property="og:image" content={meta.image} />}
</head>
<body>
  <Redirecionamento>
    <Fragment slot="title">
      Redirecionamento {redirectType}.
    </Fragment>

    <Fragment slot="description">
      Se você não for redirecionado, <a href={target}>clique aqui</a> ou copie manualmente o endereço <span><strong><output>{target}</output></strong></span>.
    </Fragment>

    <Fragment slot="bridge-links">
      {bridgeLinks.length > 0 && (<>
            <li>/p/{slug}</li>
            {bridgeLinks.map(link => (
              <li>{link}</li>
            ))}
            <li>{target}</li>
      </>)}
    </Fragment>
  </Redirecionamento>
</body>
</html>